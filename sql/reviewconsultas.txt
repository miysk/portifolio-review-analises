-- Passo 1: Adicionar a nova coluna para a data convertida
ALTER TABLE dbo.Reclamacoes
ADD data_convertida DATE;
GO

-- Passo 2: Atualizar a nova coluna com os valores convertidos da coluna de texto
UPDATE dbo.Reclamacoes
SET data_convertida = TRY_CONVERT(DATE,
    CASE 
        WHEN CHARINDEX(' às ', data) > 0 THEN SUBSTRING(data, 1, CHARINDEX(' às ', data) - 1) 
        ELSE NULL -- Ignora formatos inesperados
    END, 103) -- 103 é o código de estilo para formato dd/mm/yyyy
WHERE data IS NOT NULL;


-- Agrupa as reclamações em temas predefinidos para análise.
WITH TabelaComTemas AS (
    SELECT 
        CASE 
            WHEN LOWER(descricao_completa) LIKE '%entrega%' OR LOWER(descricao_completa) LIKE '%atraso%' OR LOWER(descricao_completa) LIKE '%rastreio%' THEN 'Logística e Entrega'
            WHEN LOWER(descricao_completa) LIKE '%reembolso%' OR LOWER(descricao_completa) LIKE '%estorno%' OR LOWER(descricao_completa) LIKE '%pagamento%' THEN 'Pagamento'
            WHEN LOWER(descricao_completa) LIKE '%cancelamento%' OR LOWER(descricao_completa) LIKE '%cancelar%' THEN 'Cancelamento'
            WHEN LOWER(descricao_completa) LIKE '%produto%' AND (LOWER(descricao_completa) LIKE '%defeito%' OR LOWER(descricao_completa) LIKE '%errado%') THEN 'Produto'
            WHEN LOWER(descricao_completa) LIKE '%propaganda enganosa%' THEN 'Publicidade'
            ELSE 'Outros'
        END AS Tema
    FROM dbo.Reclamacoes
)
SELECT 
    Tema,
    COUNT(*) AS Quantidade
FROM TabelaComTemas
GROUP BY Tema
ORDER BY Quantidade DESC;

-- Conta o número total de reclamações para cada dia da semana.
SELECT
    DATENAME(WEEKDAY, data_convertida) AS dia_da_semana,
    COUNT(*) AS total_reclamacoes
FROM dbo.Reclamacoes
WHERE data_convertida IS NOT NULL
GROUP BY 
    DATENAME(WEEKDAY

